# PolicyEdge Options Agent v2

**Purpose:** End‑to‑end, auditable options scanner agent with:
- Tripwire engine (market + policy)
- Options chain adapter (mock + provider interface + Black‑Scholes greeks)
- Supabase logging + audit bundle
- Crosswalk to PolicyEdge modules (Tariff Reflex, Market Manipulation, EconPulse, CapabilityProjection)
- Next.js (Vercel) dashboard

> Engineering scaffold for compliance-grade workflows. Not investment advice.

---

## Quick Start (Vercel + Supabase)
1. **Supabase** → run `supabase/schema.sql` then `supabase/rls.sql`.
2. **Vercel** → import `vercel_app/` as a project. Add env (see `.env.example`), select Node.js runtime for `/api/**` and Edge where noted.
3. **Deploy**. Use the dashboard at `/` and APIs under `/api/options-agent/*`.

### Environment
Copy `vercel_app/.env.example` to `.env` and set:
- `NEXT_PUBLIC_SUPABASE_URL` / `SUPABASE_SERVICE_ROLE` / `NEXT_PUBLIC_SUPABASE_ANON`
- Provider keys (optional): `POLYGON_API_KEY`, `ALPACA_API_KEY`, etc.
- Crosswalk endpoints (optional): `REFLEX_ORCHESTRATOR_URL`, `REG_AGENT_URL`, `TARIFF_REFLEX_URL`, `MKT_SURVEIL_URL`, `ECONPULSE_URL`

---

## Modules
- **Tripwire Engine**: `vercel_app/lib/tripwires.ts`  
- **Options Logic + Greeks**: `vercel_app/lib/options.ts`
- **Adapters**: `vercel_app/lib/adapters/*` (polygon, alpaca, mock)
- **API routes**: `vercel_app/app/api/options-agent/*`
- **Dashboard**: `vercel_app/app/page.tsx` + components
- **Crosswalk bridge**: `vercel_app/lib/reflexBridge.ts` + `crosswalk/crosswalk.json`
- **Audit bundles**: `vercel_app/app/api/options-agent/audit/route.ts`

---

## Methodology (Scientific-Process)
1) **Signal Ingest**: Prices, breadth, policy deltas, IV term data → normalized payload.  
2) **Hypothesis/Tripwire**: Code-based conditions (e.g., small-cap outperformance, tariff spike).  
3) **Structure Design**: Pick spread templates; **strike/delta selection** via chain adapter + BS greeks.  
4) **Risk Logging**: Store inputs, outputs, hashes, and rationale in Supabase for audit trail.  
5) **Crosswalk**: Fire connected modules (Tariff Reflex, Market Surveillance, EconPulse) for second‑order checks.  
6) **Feedback**: ActionCards → dashboard → acceptance/override; write back decisions.  

All steps produce artifacts (JSON) with SHA hashing in `tripwire_hits` and `trades_log`.

---

## Tripwire Set (v2)
- `SMALL_CAP_OUTPERFORM` – IWM vs SPY + breadth window confirmation
- `NVDA_MOMENTUM` – breakout vs prior high + EMA pullback (upstream)
- `RATES_SHOCK_GUARD` – TLT drawdown with XLF non‑confirm
- `POLICY_TARIFF_SPIKE` – front/back IV spread ≥ 6 vol pts
- `VIX_REGIME_UPSHIFT` – VIX ≥ 20 and +10% d/d → reduce net long vega
- `EARNINGS_LOCKOUT` – block new positions if earnings < N days unless flagged override
- `SKEW_ALERT` – call/put IV skew > S threshold → prefer spreads over naked options

---

## Crosswalk (examples)
- `POLICY_TARIFF_SPIKE` → call **Tariff Reflex** to compute SKU/sector impact; annotate ActionCard.
- `NVDA_MOMENTUM` → call **MarketManipulation_Surveillance** to screen for anomalies.
- `RATES_SHOCK_GUARD` → call **EconPulse**; annotate macro context.
- Any tripwire → call **CapabilityProjection_Reflex** to rank next best modules.

See `crosswalk/crosswalk.json` to modify.

---

## Tests
Basic route tests in `vercel_app/tests/` and a curl-able Postman collection in `/postman`.

---

## License/Disclaimer
© PolicyEdge AI. Educational scaffold; **no investment advice**. You are responsible for market data entitlements and compliance.
