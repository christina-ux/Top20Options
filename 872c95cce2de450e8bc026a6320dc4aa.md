# PolicyEdge Short Signals Kit v1

**Purpose**: Turn the 10-model framework into a working pipeline using **Supabase** (data + auth + RLS) and **n8n** (orchestration). 
The kit ships core SQL, example workflows, configs, and guardrails aligned with the **Reflex Engine** and **Titus Orchestrator**.

> ⚠️ **Disclaimer**: Educational and infrastructure-only. Not investment advice. Do not trade on these outputs without your own independent verification and legal/compliance review.

---

## Quick Start (30–60 min)

1. **Supabase**
   - Create a project. In SQL editor, run `supabase/schema.sql`, then `supabase/rls_policies.sql`, then `supabase/views.sql`, then `supabase/functions.sql`.
   - In *Auth → Policies*, ensure RLS is **enabled** (the scripts do this) and your JWT carries an `org_id` claim.
   - Optional: seed minimal data with `supabase/seed/min_seed.sql`.

2. **Edge Function (optional)**
   - Deploy `code/edge_functions/insert_signal` as a Supabase Edge Function:
     ```bash
     supabase functions deploy insert-signal
     ```

3. **n8n**
   - Import workflows in `n8n/workflows/*.json` (Tranche Short, Regulatory Shock Short, Warehouse Stress).
   - Set credentials:
     - **Postgres** → Supabase connection (host, db, user, password, SSL).
     - **HTTP Request** → Set `SUPABASE_ANON_KEY` / service key headers where required.
   - Run manually or add Cron triggers.

4. **Config**
   - Adjust `config/ccar_2025_severe.json` and `config/reflex_guardrails.json`.
   - All writes are captured in `peai.audit_log`. Signals land in `peai.signals` and appear via `peai.v_short_candidates`.

5. **Operate**
   - Use `examples/watchlist.sql` to build a live watchlist.
   - Use `templates/action_card.json5` as the structure for Slack/Email alerts.

---

## Files

- `supabase/schema.sql` — tables for loans, tranches, lenders, enforcement, warehouse, cyber, signals, runs, audit.
- `supabase/rls_policies.sql` — **RLS** per org with `auth.jwt()->>'org_id'` gate.
- `supabase/views.sql` — convenience views including `v_short_candidates`.
- `supabase/functions.sql` — `compute_composite_score()` helper and score clamps.
- `n8n/workflows/*.json` — importable n8n flows for three models (1, 2, 5).
- `config/ccar_2025_severe.json` — scenario example (HPI drop, unemployment spike).
- `config/reflex_guardrails.json` — MNPI-block and audit settings (Reflex).
- `templates/action_card.json5` — alert payload template.
- `examples/watchlist.sql` — sample query to generate shortable watchlist.
- `code/edge_functions/insert_signal/index.ts` — Supabase Edge Function to insert signals cleanly.
- `code/utils/formulas.py` — reference formulas for PD/LGD/EL and composite signals.

---

## Model→Workflow Mapping (examples in this kit)

- **#1 Tranche Default Curve Short** → `Tranche Short v1` (pool→stress→waterfall→signal).
- **#2 Regulatory Shock Short** → `Reg Shock Short v1` (HMDA+enforcement→P&L hit→signal).
- **#5 Warehouse Line Stress Arbitrage** → `Warehouse Stress v1` (price shocks→margin call→signal).

Replicate the pattern for other models (#3, #4, #6–#10): create a table for the metric, a run record, write to `peai.signals` when thresholds breach, and attach evidence (URLs, doc hashes) in `signals.evidence`.

---

## Governance & Safety

- **MNPI Block**: Guardrails enforce public-source-only inputs by default.
- **Audit-First**: Every run writes to `peai.runs` and `peai.audit_log` with scenario, params, and hash.
- **RLS**: All tables protected by org-level RLS. Queries require a JWT with `org_id`.

---

## Upgrade Paths

- Swap n8n function nodes with your hosted FastAPI agents (e.g., *MBS Stress & Tranche Analyzer v1*).
- Add Supabase **Edge Functions** for heavier vector/scoring work.
- Connect to the **PolicyEdge Orchestrator Pack** for multi-run campaigns and memo generation.

